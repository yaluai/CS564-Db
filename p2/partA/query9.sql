drop view if exists v;
drop view if exists u; 
drop view if exists t; 
create view t as 
select sales.dept, sales.store, sum(WeeklySales)/(stores.size) as norm 
from hw2.sales 
join hw2.stores on sales.store = stores.store 
group by sales.dept, sales.store, stores.size; 


create view u as 
select dept, sum(norm) as NormSales 
from t 
group by dept 
order by NormSales 
desc limit 10; 


create view v as
select u.dept, extract(year from WeekDate) as year, extract(month from WeekDate) as month, sum(sales.WeeklySales) as cumulative_sales 
from hw2.sales 
join u on hw2.sales.dept = u.dept 
group by u.dept, year, month 
order by u.dept, year, month;

select dept, year, month, sum(cumulative_sales) over (order by dept, year, month rows unbounded preceding) as total
from v;

--  dept |  year  | month |    total    
-- ------+------+----+-------------
--     2 | 2010 |  2 | 7.65827e+06
--     2 | 2010 |  3 | 1.51988e+07
--     2 | 2010 |  4 | 2.48585e+07
--     2 | 2010 |  5 | 3.26143e+07
--     2 | 2010 |  6 | 4.06403e+07
--     2 | 2010 |  7 |  5.0893e+07
--     2 | 2010 |  8 | 5.93717e+07
--     2 | 2010 |  9 | 6.72513e+07
--     2 | 2010 | 10 |   7.656e+07
--     2 | 2010 | 11 | 8.39074e+07
--     2 | 2010 | 12 | 9.40529e+07
--     2 | 2011 |  1 | 1.01011e+08
--     2 | 2011 |  2 | 1.08689e+08
--     2 | 2011 |  3 | 1.16417e+08
--     2 | 2011 |  4 | 1.25899e+08
--     2 | 2011 |  5 | 1.33478e+08
--     2 | 2011 |  6 | 1.41353e+08
--     2 | 2011 |  7 |   1.514e+08
--     2 | 2011 |  8 | 1.59768e+08
--     2 | 2011 |  9 | 1.69458e+08
--     2 | 2011 | 10 | 1.77032e+08
--     2 | 2011 | 11 | 1.84651e+08
--     2 | 2011 | 12 | 1.95558e+08
--     2 | 2012 |  1 | 2.02945e+08
--     2 | 2012 |  2 | 2.11001e+08
--     2 | 2012 |  3 | 2.20907e+08
--     2 | 2012 |  4 | 2.28735e+08
--     2 | 2012 |  5 | 2.36556e+08
--     2 | 2012 |  6 |  2.4669e+08
--     2 | 2012 |  7 | 2.54788e+08
--     2 | 2012 |  8 | 2.65281e+08
--     2 | 2012 |  9 | 2.73017e+08
--     2 | 2012 | 10 | 2.80611e+08
--    13 | 2010 |  2 | 2.86256e+08
--    13 | 2010 |  3 | 2.91823e+08
--    13 | 2010 |  4 | 2.98848e+08
--    13 | 2010 |  5 | 3.04371e+08
--    13 | 2010 |  6 | 3.10041e+08
--    13 | 2010 |  7 | 3.17223e+08
--    13 | 2010 |  8 | 3.23108e+08
--    13 | 2010 |  9 | 3.29032e+08
--    13 | 2010 | 10 | 3.36045e+08
--    13 | 2010 | 11 |  3.4154e+08
--    13 | 2010 | 12 | 3.47894e+08
--    13 | 2011 |  1 | 3.53135e+08
--    13 | 2011 |  2 | 3.58606e+08
--    13 | 2011 |  3 | 3.64125e+08
--    13 | 2011 |  4 | 3.70698e+08
--    13 | 2011 |  5 | 3.75987e+08
--    13 | 2011 |  6 | 3.81312e+08
--    13 | 2011 |  7 | 3.88121e+08
--    13 | 2011 |  8 | 3.93919e+08
--    13 | 2011 |  9 | 4.01009e+08
--    13 | 2011 | 10 | 4.06621e+08
--    13 | 2011 | 11 | 4.12048e+08
--    13 | 2011 | 12 | 4.18422e+08
--    13 | 2012 |  1 | 4.23706e+08
--    13 | 2012 |  2 | 4.29202e+08
--    13 | 2012 |  3 | 4.36114e+08
--    13 | 2012 |  4 | 4.41526e+08
--    13 | 2012 |  5 | 4.46906e+08
--    13 | 2012 |  6 | 4.53753e+08
--    13 | 2012 |  7 |  4.5927e+08
--    13 | 2012 |  8 | 4.66643e+08
--    13 | 2012 |  9 | 4.72346e+08
--    13 | 2012 | 10 | 4.77933e+08
--    38 | 2010 |  2 | 4.89112e+08
--    38 | 2010 |  3 | 5.00346e+08
--    38 | 2010 |  4 | 5.14139e+08
--    38 | 2010 |  5 | 5.25082e+08
--    38 | 2010 |  6 | 5.35487e+08
--    38 | 2010 |  7 | 5.48581e+08
--    38 | 2010 |  8 | 5.59071e+08
--    38 | 2010 |  9 | 5.69694e+08
--    38 | 2010 | 10 | 5.83063e+08
--    38 | 2010 | 11 | 5.93348e+08
--    38 | 2010 | 12 | 6.06788e+08
--    38 | 2011 |  1 | 6.18368e+08
--    38 | 2011 |  2 | 6.29624e+08
--    38 | 2010 |  3 | 5.00346e+08
--    38 | 2010 |  4 | 5.14139e+08
--    38 | 2010 |  5 | 5.25082e+08
--    38 | 2010 |  6 | 5.35487e+08
--    38 | 2010 |  7 | 5.48581e+08
--    38 | 2010 |  8 | 5.59071e+08
--    38 | 2010 |  9 | 5.69694e+08
--    38 | 2010 | 10 | 5.83063e+08
--    38 | 2010 | 11 | 5.93348e+08
--    38 | 2010 | 12 | 6.06788e+08
--    38 | 2011 |  1 | 6.18368e+08
--    38 | 2011 |  2 | 6.29624e+08
--    38 | 2011 |  3 | 6.40819e+08
--    38 | 2011 |  4 | 6.54645e+08
--    38 | 2011 |  5 | 6.65717e+08
--    38 | 2011 |  6 | 6.76442e+08
--    38 | 2011 |  7 | 6.89749e+08
--    38 | 2011 |  8 | 7.00591e+08
--    38 | 2011 |  9 | 7.14254e+08
--    38 | 2011 | 10 | 7.25224e+08
--    38 | 2011 | 11 | 7.35996e+08
--    38 | 2011 | 12 | 7.50049e+08
--    38 | 2012 |  1 | 7.61932e+08
--    38 | 2012 |  2 | 7.73788e+08
--    38 | 2012 |  3 | 7.88624e+08
--    38 | 2012 |  4 | 8.00339e+08
--    38 | 2012 |  5 | 8.11881e+08
--    38 | 2012 |  6 | 8.25316e+08
--    38 | 2012 |  7 | 8.36224e+08
--    38 | 2012 |  8 | 8.49618e+08
--    38 | 2012 |  9 |  8.6034e+08
--    38 | 2012 | 10 | 8.71051e+08
--    40 | 2010 |  2 | 8.79575e+08
--    40 | 2010 |  3 | 8.87956e+08
--    40 | 2010 |  4 | 8.98156e+08
--    40 | 2010 |  5 | 9.06119e+08
--    40 | 2010 |  6 | 9.13997e+08
--    40 | 2010 |  7 | 9.23788e+08
--    40 | 2010 |  8 | 9.31571e+08
--    40 | 2010 |  9 | 9.39532e+08
--    40 | 2010 | 10 | 9.49361e+08
--    40 | 2010 | 11 | 9.57181e+08
--    40 | 2010 | 12 | 9.67466e+08
--    40 | 2011 |  1 | 9.75645e+08
--    40 | 2011 |  2 | 9.84119e+08
--    40 | 2011 |  3 | 9.92465e+08
--    40 | 2011 |  4 | 1.00232e+09
--    40 | 2011 |  5 | 1.01016e+09
--    40 | 2011 |  6 | 1.01788e+09
--    40 | 2011 |  7 | 1.02736e+09
--    40 | 2011 |  8 | 1.03512e+09
--    40 | 2011 |  9 | 1.04485e+09
--    40 | 2011 | 10 | 1.05274e+09
--    40 | 2011 | 11 | 1.06054e+09
--    40 | 2011 | 12 | 1.07079e+09
--    40 | 2012 |  1 | 1.07927e+09
--    40 | 2012 |  2 | 1.08798e+09
--    40 | 2012 |  3 | 1.09872e+09
--    40 | 2012 |  4 | 1.10703e+09
--    40 | 2012 |  5 | 1.11517e+09
--    40 | 2012 |  6 | 1.12524e+09
--    40 | 2012 |  7 |  1.1332e+09
--    40 | 2012 |  8 | 1.14349e+09
--    40 | 2012 |  9 | 1.15181e+09
--    40 | 2012 | 10 | 1.15999e+09
--    72 | 2010 |  2 | 1.17207e+09
--    72 | 2010 |  3 | 1.18078e+09
--    72 | 2010 |  4 | 1.18977e+09
--    72 | 2010 |  5 | 1.19648e+09
--    72 | 2010 |  6 | 1.20364e+09
--    72 | 2010 |  7 | 1.21255e+09
--    72 | 2010 |  8 | 1.22053e+09
--    72 | 2010 |  9 | 1.22802e+09
--    72 | 2010 | 10 | 1.23624e+09
--    72 | 2010 | 11 | 1.25277e+09
--    72 | 2010 | 12 |  1.2705e+09
--    72 | 2011 |  1 | 1.27784e+09
--    72 | 2011 |  2 | 1.28892e+09
--    72 | 2011 |  3 |  1.2976e+09
--    72 | 2011 |  4 | 1.30653e+09
--    72 | 2011 |  5 |  1.3131e+09
--    72 | 2011 |  6 | 1.31997e+09
--    72 | 2011 |  7 | 1.32817e+09
--    72 | 2011 |  8 | 1.33562e+09
--    72 | 2011 |  9 |  1.3445e+09
--    72 | 2011 | 10 | 1.35268e+09
--    72 | 2011 | 11 | 1.36978e+09
--    72 | 2011 | 12 |  1.3854e+09
--    72 | 2012 |  1 | 1.39244e+09
--    72 | 2012 |  2 |  1.4034e+09
--    72 | 2012 |  3 | 1.41318e+09
--    72 | 2012 |  4 | 1.41993e+09
--    72 | 2012 |  5 | 1.42645e+09
--    72 | 2012 |  6 | 1.43478e+09
--    72 | 2012 |  7 | 1.44133e+09
--    72 | 2012 |  8 |  1.4503e+09
--    72 | 2012 |  9 | 1.45815e+09
--    72 | 2012 | 10 | 1.46571e+09
--    90 | 2010 |  2 | 1.47385e+09
--    90 | 2010 |  3 | 1.48158e+09
--    90 | 2010 |  4 | 1.49103e+09
--    90 | 2010 |  5 | 1.49851e+09
--    90 | 2010 |  6 | 1.50607e+09
--    90 | 2010 |  7 |  1.5155e+09
--    90 | 2010 |  8 | 1.52316e+09
--    90 | 2010 |  9 | 1.53094e+09
--    90 | 2010 | 10 | 1.54042e+09
--    90 | 2010 | 11 | 1.54866e+09
--    90 | 2010 | 12 | 1.55912e+09
--    90 | 2011 |  1 | 1.56713e+09
--    90 | 2011 |  2 | 1.57536e+09
--    90 | 2011 |  3 | 1.58337e+09
--    90 | 2011 |  4 | 1.59337e+09
--    90 | 2010 |  5 | 1.49851e+09
--    90 | 2010 |  6 | 1.50607e+09
--    90 | 2010 |  7 |  1.5155e+09
--    90 | 2010 |  8 | 1.52316e+09
--    90 | 2010 |  9 | 1.53094e+09
--    90 | 2010 | 10 | 1.54042e+09
--    90 | 2010 | 11 | 1.54866e+09
--    90 | 2010 | 12 | 1.55912e+09
--    90 | 2011 |  1 | 1.56713e+09
--    90 | 2011 |  2 | 1.57536e+09
--    90 | 2011 |  3 | 1.58337e+09
--    90 | 2011 |  4 | 1.59337e+09
--    90 | 2011 |  5 | 1.60124e+09
--    90 | 2011 |  6 | 1.60916e+09
--    90 | 2011 |  7 | 1.61913e+09
--    90 | 2011 |  8 | 1.62753e+09
--    90 | 2011 |  9 |   1.638e+09
--    90 | 2011 | 10 | 1.64662e+09
--    90 | 2011 | 11 | 1.65572e+09
--    90 | 2011 | 12 | 1.66706e+09
--    90 | 2012 |  1 | 1.67575e+09
--    90 | 2012 |  2 | 1.68448e+09
--    90 | 2012 |  3 | 1.69493e+09
--    90 | 2012 |  4 | 1.70329e+09
--    90 | 2012 |  5 | 1.71142e+09
--    90 | 2012 |  6 | 1.72146e+09
--    90 | 2012 |  7 | 1.72954e+09
--    90 | 2012 |  8 |  1.7398e+09
--    90 | 2012 |  9 | 1.74817e+09
--    90 | 2012 | 10 | 1.75678e+09
--    91 | 2010 |  2 | 1.76317e+09
--    91 | 2010 |  3 | 1.76924e+09
--    91 | 2010 |  4 | 1.77661e+09
--    91 | 2010 |  5 | 1.78259e+09
--    91 | 2010 |  6 | 1.78868e+09
--    91 | 2010 |  7 | 1.79606e+09
--    91 | 2010 |  8 | 1.80205e+09
--    91 | 2010 |  9 |   1.808e+09
--    91 | 2010 | 10 | 1.81523e+09
--    91 | 2010 | 11 |  1.8211e+09
--    91 | 2010 | 12 | 1.82821e+09
--    91 | 2011 |  1 | 1.83446e+09
--    91 | 2011 |  2 | 1.84092e+09
--    91 | 2011 |  3 | 1.84714e+09
--    91 | 2011 |  4 |  1.8546e+09
--    91 | 2011 |  5 | 1.86057e+09
--    91 | 2011 |  6 | 1.86661e+09
--    91 | 2011 |  7 | 1.87404e+09
--    91 | 2011 |  8 |  1.8802e+09
--    91 | 2011 |  9 |  1.8876e+09
--    91 | 2011 | 10 | 1.89379e+09
--    91 | 2011 | 11 | 1.89983e+09
--    91 | 2011 | 12 | 1.90707e+09
--    91 | 2012 |  1 | 1.91344e+09
--    91 | 2012 |  2 | 1.91996e+09
--    91 | 2012 |  3 | 1.92769e+09
--    91 | 2012 |  4 | 1.93388e+09
--    91 | 2012 |  5 | 1.94005e+09
--    91 | 2012 |  6 | 1.94768e+09
--    91 | 2012 |  7 | 1.95382e+09
--    91 | 2012 |  8 | 1.96141e+09
--    91 | 2012 |  9 | 1.96747e+09
--    91 | 2012 | 10 | 1.97356e+09
--    92 | 2010 |  2 |  1.9873e+09
--    92 | 2010 |  3 | 2.00021e+09
--    92 | 2010 |  4 |  2.0157e+09
--    92 | 2010 |  5 | 2.02817e+09
--    92 | 2010 |  6 | 2.04061e+09
--    92 | 2010 |  7 | 2.05582e+09
--    92 | 2010 |  8 | 2.06846e+09
--    92 | 2010 |  9 | 2.08126e+09
--    92 | 2010 | 10 | 2.09711e+09
--    92 | 2010 | 11 |  2.1119e+09
--    92 | 2010 | 12 |  2.1294e+09
--    92 | 2011 |  1 |  2.1427e+09
--    92 | 2011 |  2 |  2.1563e+09
--    92 | 2011 |  3 | 2.16941e+09
--    92 | 2011 |  4 | 2.18526e+09
--    92 | 2011 |  5 | 2.19787e+09
--    92 | 2010 |  6 | 2.04061e+09
--    92 | 2010 |  7 | 2.05582e+09
--    92 | 2010 |  8 | 2.06846e+09
--    92 | 2010 |  9 | 2.08126e+09
--    92 | 2010 | 10 | 2.09711e+09
--    92 | 2010 | 11 |  2.1119e+09
--    92 | 2010 | 12 |  2.1294e+09
--    92 | 2011 |  1 |  2.1427e+09
--    92 | 2011 |  2 |  2.1563e+09
--    92 | 2011 |  3 | 2.16941e+09
--    92 | 2011 |  4 | 2.18526e+09
--    92 | 2011 |  5 | 2.19787e+09
--    92 | 2011 |  6 | 2.21049e+09
--    92 | 2011 |  7 | 2.22629e+09
--    92 | 2011 |  8 | 2.23978e+09
--    92 | 2011 |  9 | 2.25647e+09
--    92 | 2011 | 10 | 2.27068e+09
--    92 | 2011 | 11 | 2.28671e+09
--    92 | 2011 | 12 | 2.30588e+09
--    92 | 2012 |  1 | 2.32041e+09
--    92 | 2012 |  2 | 2.33517e+09
--    92 | 2012 |  3 | 2.35263e+09
--    92 | 2012 |  4 | 2.36658e+09
--    92 | 2012 |  5 | 2.38037e+09
--    92 | 2012 |  6 | 2.39732e+09
--    92 | 2012 |  7 | 2.41105e+09
--    92 | 2012 |  8 | 2.42848e+09
--    92 | 2012 |  9 | 2.44273e+09
--    92 | 2012 | 10 | 2.45751e+09
--    94 | 2010 |  2 | 2.46285e+09
--    94 | 2012 |  3 | 2.60591e+09
--    94 | 2012 |  4 |  2.6113e+09
--    94 | 2012 |  5 | 2.61721e+09
--    94 | 2012 |  6 | 2.62445e+09
--    94 | 2012 |  7 | 2.63022e+09
--    94 | 2012 |  8 | 2.63701e+09
--    94 | 2012 |  9 | 2.64217e+09
--    94 | 2012 | 10 | 2.64742e+09
--    95 | 2010 |  2 | 2.65917e+09
--    95 | 2010 |  3 | 2.67103e+09
--    95 | 2010 |  4 | 2.68663e+09
--    95 | 2010 |  5 | 2.70001e+09
--    95 | 2010 |  6 | 2.71416e+09
--    95 | 2010 |  7 | 2.73117e+09
--    95 | 2010 |  8 | 2.74448e+09
--    95 | 2010 |  9 | 2.75714e+09
--    95 | 2010 | 10 | 2.77183e+09
--    95 | 2010 | 11 | 2.78311e+09
--    95 | 2010 | 12 | 2.79728e+09
--    95 | 2011 |  1 | 2.80851e+09
--    95 | 2011 |  2 | 2.82043e+09
--    95 | 2011 |  3 | 2.83247e+09
--    95 | 2011 |  4 | 2.84737e+09
--    95 | 2011 |  5 |    2.86e+09
--    95 | 2011 |  6 | 2.87365e+09
--    95 | 2011 |  7 |  2.8907e+09
--    95 | 2011 |  8 | 2.90434e+09
--    95 | 2011 |  9 | 2.92013e+09
--    95 | 2011 | 10 | 2.93245e+09
--    95 | 2011 | 11 | 2.94422e+09
--    95 | 2011 | 12 | 2.95885e+09
--    95 | 2012 |  1 | 2.97056e+09
--    95 | 2012 |  2 | 2.98271e+09
--    95 | 2012 |  3 | 2.99816e+09
--    95 | 2012 |  4 | 3.01087e+09
--    95 | 2012 |  5 | 3.02408e+09
--    95 | 2012 |  6 | 3.04121e+09
--    95 | 2012 |  7 | 3.05493e+09
--    95 | 2012 |  8 | 3.07169e+09
--    95 | 2012 |  9 | 3.08442e+09
--    95 | 2012 | 10 | 3.09674e+09
-- (330 rows)